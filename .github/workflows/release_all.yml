name: Release binaries (Linux, macOS, Windows)

on:
  release:
    types: [created]

jobs:
  build:
    name: Build release â€“ ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # ---------- Install compilers / tools per OS ----------

      - name: Install compilers (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y gfortran make

      - name: Install compilers (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install gcc@12
          # Make gfortran available as "gfortran"
          sudo ln -s $(which gfortran-12) $(dirname $(which gfortran-12))/gfortran || true

      - name: Setup MSYS2 and mingw-w64 toolchain (Windows)
        if: matrix.os == 'windows-latest'
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >-
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-make
            mingw-w64-x86_64-gcc-fortran

      - name: Install cmake (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          choco install cmake -y

      - name: Check gfortran (Windows)
        if: matrix.os == 'windows-latest'
        shell: bash
        run: |
          if command -v gfortran >/dev/null 2>&1; then
            gfortran --version
          else
            echo "gfortran not found in MSYS2/mingw PATH; aborting.";
            exit 1;
          fi

      # ---------- Build binaries per OS ----------

      - name: Compile sources (Linux/macOS)
        if: matrix.os == 'ubuntu-latest' || matrix.os == 'macos-latest'
        run: |
          make -C src -f makefile

      - name: Compile sources (Windows)
        if: matrix.os == 'windows-latest'
        shell: bash
        run: |
          make -C src -f makefile EXT=.exe

      # ---------- Package artifacts per OS ----------

      - name: Package Linux binaries
        if: matrix.os == 'ubuntu-latest'
        run: |
          mkdir binary
          # Copy executables from src/ to binary/
          find src -maxdepth 1 -type f -perm -111 -exec cp {} binary \;
          tar -pczf Perple_X_Linux_64_gfortran.tar.gz binary datafiles optionfiles matlab_scripts

      - name: Upload Linux artifact
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: Perple_X_Linux_64_gfortran.tar.gz
          path: Perple_X_Linux_64_gfortran.tar.gz

      - name: Package macOS binaries
        if: matrix.os == 'macos-latest'
        run: |
          mkdir binary
          # Copy executables from src/ to binary/
          find src -maxdepth 1 -type f -perm -111 -exec cp {} binary \;
          tar -pczf Perple_X_macOS_64_gfortran.tar.gz binary datafiles optionfiles matlab_scripts

      - name: Upload macOS artifact
        if: matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: Perple_X_macOS_64_gfortran.tar.gz
          path: Perple_X_macOS_64_gfortran.tar.gz

      - name: Package Windows binaries
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path binary -Force | Out-Null
          Get-ChildItem -Path src -Filter *.exe -Recurse | Copy-Item -Destination binary
          Compress-Archive -Path binary, datafiles, optionfiles, matlab_scripts `
            -DestinationPath Perple_X_Windows_64_gfortran.zip -Force

      - name: Upload Windows artifact
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: Perple_X_Windows_64_gfortran.zip
          path: Perple_X_Windows_64_gfortran.zip

  publish:
    name: Publish release artifacts
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download Linux artifact (tolerant)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: Perple_X_Linux_64_gfortran.tar.gz

      - name: Download macOS artifact (tolerant)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: Perple_X_macOS_64_gfortran.tar.gz

      - name: Download Windows artifact (tolerant)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: Perple_X_Windows_64_gfortran.zip

      - name: Build list of artifacts to publish
        id: build_list
        run: |
          files=""
          for f in Perple_X_Linux_64_gfortran.tar.gz Perple_X_macOS_64_gfortran.tar.gz Perple_X_Windows_64_gfortran.zip; do
            if [ -f "$f" ]; then
              files="$files $f"
            fi
          done
          files=$(echo "$files" | xargs)
          echo "Found files:$files"
          echo "files=$files" >> "$GITHUB_OUTPUT"

      - name: Publish artifacts to GitHub release (if any)
        if: steps.build_list.outputs.files != ''
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.event.release.tag_name }}
          files: ${{ steps.build_list.outputs.files }}

      - name: Log no artifacts found
        if: steps.build_list.outputs.files == ''
        run: |
          echo "No build artifacts were found to publish."
