name: Release binaries (Linux, macOS, Windows)

on:
  release:
    types: [created]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build release â€“ ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-22.04
          - macos-latest
          - windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ---------- Install compilers / tools per OS ----------

      - name: Install compilers (Linux)
        if: matrix.os == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y gfortran make

      - name: Install compilers (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew update
          brew install gcc
          echo "$(brew --prefix)/bin" >> $GITHUB_PATH
          ls -l "$(brew --prefix)/bin"/gfortran* || true
          command -v gfortran || true
          command -v gfortran-15 || true

      - name: Setup MSYS2 and mingw-w64 toolchain (Windows)
        if: matrix.os == 'windows-latest'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          path-type: inherit
          update: true
          install: >-
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-make

      - name: Check gfortran (Windows)
        if: matrix.os == 'windows-latest'
        shell: msys2 {0}
        run: |
          export PATH=/mingw64/bin:$PATH
          echo "MSYSTEM=$MSYSTEM"
          echo "PATH=$PATH"
          ls -la /mingw64/bin/gfortran* || true
          which gfortran || true
          pacman -Q | grep -E "gcc|gfortran|toolchain" || true
          gfortran --version

      - name: Debug quadmath static availability (Linux)
        if: matrix.os == 'ubuntu-22.04'
        run: |
          gfortran --version
          echo "libquadmath.a path:"
          gfortran -print-file-name=libquadmath.a
          echo "libquadmath.so path:"
          gfortran -print-file-name=libquadmath.so
          ls -l "$(gfortran -print-file-name=libquadmath.a)" || true

      # ---------- Build binaries per OS ----------

      - name: Compile sources (Linux)
        if: matrix.os == 'ubuntu-22.04'
        run: |
          make -C src -f makefile STATIC=1 FC=gfortran 

      - name: Compile sources (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          make -C src -f makefile STATIC=1 FC=gfortran-15

      - name: Compile sources (Windows)
        if: matrix.os == 'windows-latest'
        shell: msys2 {0}
        run: |
          export PATH=/mingw64/bin:$PATH
          make -C src -f makefile EXT=.exe STATIC=1 FC=gfortran

      #----------- Linux Check -----------------------
      - name: Check runtime deps (Linux)
        if: matrix.os == 'ubuntu-22.04'
        run: |
          set -e
          for f in src/*; do
            if [ -x "$f" ] && file "$f" | grep -q ELF; then
              echo "== $f =="
              if ldd "$f" | grep -Eiq "gfortran|quadmath|gcc_s"; then
                echo "Found unwanted runtime deps in $f"
                ldd "$f"
                exit 1
              fi
            fi
          done

      #----------- Windows Check -----------------------
      - name: Check runtime deps (Windows)
        if: matrix.os == 'windows-latest'
        shell: msys2 {0}
        run: |
          export PATH=/mingw64/bin:$PATH
          set -e
          for f in src/*.exe; do
            echo "== $f =="
            objdump -p "$f" | grep -Ei "DLL Name:.*(gfortran|quadmath|gcc|winpthread)" && exit 1 || true
          done
      # ---------- Package artifacts per OS ----------

      - name: Package Linux binaries
        if: matrix.os == 'ubuntu-22.04'
        run: |
          set -e
          TAG=${{ github.event.release.tag_name }}
          PKG=Perple_X_${TAG}_Linux_64_gfortran
          rm -rf "$PKG"
          mkdir -p "$PKG/bin"

          # Copy executables
          find src -maxdepth 1 -type f -perm -111 -exec cp {} "$PKG/bin/" \;

          # Copy support directories if they exist
          for d in datafiles optionfiles matlab_scripts; do
            if [ -d "$d" ]; then
              cp -r "$d" "$PKG/"
            fi
          done

          # Sanity check: packaged Linux executables must not depend on gfortran/quadmath/gcc_s
          for f in "$PKG/bin/"*; do
            if [ -x "$f" ] && file "$f" | grep -q ELF; then
              echo "== $f =="
              if ldd "$f" | grep -Eiq "gfortran|quadmath|gcc_s"; then
                echo "ERROR: unwanted runtime deps detected in packaged executable: $f"
                ldd "$f"
                exit 1
              fi
            fi
          done

          tar -czf "${PKG}.tar.gz" "$PKG"

      - name: Upload Linux artifact
        if: matrix.os == 'ubuntu-22.04'
        uses: actions/upload-artifact@v4
        with:
          name: Perple_X_${{ github.event.release.tag_name }}_Linux_64_gfortran.tar.gz
          path: Perple_X_${{ github.event.release.tag_name }}_Linux_64_gfortran.tar.gz

        
      - name: Package macOS binaries
        if: matrix.os == 'macos-latest'
        run: |
          set -euo pipefail

          TAG=${{ github.event.release.tag_name }}
          PKG=Perple_X_${TAG}_macOS_64_gfortran
          rm -rf "$PKG"
          mkdir -p "$PKG/bin" "$PKG/lib"

          # Copy executables
          find src -maxdepth 1 -type f -perm -111 -exec cp {} "$PKG/bin/" \;

          # Copy support directories if they exist
          for d in datafiles optionfiles matlab_scripts; do
            if [ -d "$d" ]; then
              cp -r "$d" "$PKG/"
            fi
          done

          # Locate Homebrew GCC runtime directory (works on Apple Silicon and Intel runners)
          BREW_PREFIX="$(brew --prefix)"
          GCC_PREFIX="$(brew --prefix gcc)"
          GCC_LIBDIR="${GCC_PREFIX}/lib/gcc/current"
          echo "BREW_PREFIX=$BREW_PREFIX"
          echo "GCC_PREFIX=$GCC_PREFIX"
          echo "GCC_LIBDIR=$GCC_LIBDIR"
          ls -al "$GCC_LIBDIR" || true

          # Bundle required GCC runtime dylibs
          NEED_LIBS=("libgfortran.5.dylib" "libquadmath.0.dylib" "libgcc_s.1.1.dylib")
          for lib in "${NEED_LIBS[@]}"; do
            src="${GCC_LIBDIR}/${lib}"
            if [ -f "$src" ]; then
              cp "$src" "$PKG/lib/"
            else
              echo "ERROR: expected $lib not found at $src"
              exit 1
            fi
          done

          # Ensure executables can find bundled dylibs
          for exe in "$PKG/bin/"*; do
            if file "$exe" | grep -q Mach-O; then
              install_name_tool -add_rpath "@executable_path/../lib" "$exe" 2>/dev/null || true
            fi
          done

          # Set dylib IDs to @rpath/<name> (important for relocatable bundles)
          for dylib in "$PKG/lib/"*.dylib; do
            base="$(basename "$dylib")"
            install_name_tool -id "@rpath/$base" "$dylib" 2>/dev/null || true
          done

          # Rewrite references from Homebrew absolute paths -> @rpath for BOTH executables and dylibs
          # (libgfortran itself depends on libquadmath and libgcc_s)
          TARGETS=( "$PKG/bin/"* "$PKG/lib/"*.dylib )
          for t in "${TARGETS[@]}"; do
            if [ -e "$t" ] && file "$t" | grep -q Mach-O; then
              for lib in "${NEED_LIBS[@]}"; do
                install_name_tool -change "${GCC_LIBDIR}/${lib}" "@rpath/${lib}" "$t" 2>/dev/null || true
              done
            fi
          done

          # Diagnostics: show what the binaries will load
          for exe in "$PKG/bin/"*; do
            if file "$exe" | grep -q Mach-O; then
              echo "== otool -L $exe =="
              otool -L "$exe"
            fi
          done

          # remove any existing archives inside package to avoid nesting
          find "$PKG" -type f \( -name '*.zip' -o -name '*.tar.gz' -o -name '*.tgz' \) -delete || true
          ARCHIVE=${PKG}.tar.gz
          tar -C . -czf "$ARCHIVE" "$PKG"

          # Sanity check: ensure no Homebrew paths remain
          for exe in "$PKG/bin/"*; do
            if file "$exe" | grep -q Mach-O; then
              if otool -L "$exe" | grep -E "/opt/homebrew|/usr/local"; then
                echo "ERROR: non-system library path detected in $exe"
                exit 1
              fi
            fi
          done

      - name: Upload macOS artifact
        if: matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: Perple_X_${{ github.event.release.tag_name }}_macOS_64_gfortran.tar.gz
          path: Perple_X_${{ github.event.release.tag_name }}_macOS_64_gfortran.tar.gz

      - name: Package Windows binaries
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $tag = '${{ github.event.release.tag_name }}'
          $pkg = "Perple_X_${tag}_Windows_64_gfortran"
          if (Test-Path $pkg) { Remove-Item -Recurse -Force $pkg }
          New-Item -ItemType Directory -Path "$pkg\bin" -Force | Out-Null
          Get-ChildItem -Path src -Filter *.exe -File | ForEach-Object { Copy-Item -Path $_.FullName -Destination "$pkg\bin\" }
          foreach ($d in @('datafiles','optionfiles','matlab_scripts')) {
            if (Test-Path $d) { Copy-Item -Recurse -Path $d -Destination $pkg }
          }
          Get-ChildItem -Path $pkg -Recurse -Include '*.zip','*.tar.gz','*.tgz' -File -ErrorAction SilentlyContinue | Remove-Item -Force -ErrorAction SilentlyContinue
          $zip = "$pkg.zip"
          Compress-Archive -Path "$pkg\*" -DestinationPath $zip -Force


      - name: Upload Windows artifact
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: Perple_X_${{ github.event.release.tag_name }}_Windows_64_gfortran.zip
          path: Perple_X_${{ github.event.release.tag_name }}_Windows_64_gfortran.zip

  publish:
    name: Publish release artifacts
    needs: build
    runs-on: ubuntu-22.04
    steps:

      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: Perple_X_${{ github.event.release.tag_name }}_Linux_64_gfortran.tar.gz
          path: artifacts

      - name: Verify Linux artifact exists
        run: |
          ls -al artifacts
          test -f "artifacts/Perple_X_${{ github.event.release.tag_name }}_Linux_64_gfortran.tar.gz"

      - name: Download macOS artifact (tolerant)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: Perple_X_${{ github.event.release.tag_name }}_macOS_64_gfortran.tar.gz
          path: artifacts

      - name: Download Windows artifact (tolerant)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: Perple_X_${{ github.event.release.tag_name }}_Windows_64_gfortran.zip
          path: artifacts

      - name: List downloaded artifacts for debugging
        run: |
          echo "Listing ./artifacts contents"
          ls -al artifacts || true
          echo "Listing workspace root"
          ls -al || true

      - name: Build list of artifacts to publish
        id: build_list
        run: |
          TAG=${{ github.event.release.tag_name }}
          patterns=(
            "Perple_X_${TAG}_Linux_64_gfortran.tar.gz"
            "Perple_X_${TAG}_macOS_64_gfortran.tar.gz"
            "Perple_X_${TAG}_Windows_64_gfortran.zip"
          )
          files=""
          # search ./artifacts for matching files and copy them to workspace root
          for p in "${patterns[@]}"; do
            found=$(find artifacts -type f -name "$p" -print -quit || true)
            if [ -n "$found" ]; then
              base=$(basename "$found")
              cp "$found" "$base"
              files="$files $base"
            fi
          done
          # normalize whitespace
          files=$(echo $files | xargs || true)
          if [ -n "$files" ]; then
            echo "Found files: $files"
            echo "files<<EOF" >> "$GITHUB_OUTPUT"
            for f in $files; do
              echo "$f" >> "$GITHUB_OUTPUT"
            done
            echo "EOF" >> "$GITHUB_OUTPUT"
          else
            echo "Found files: (none)"
            echo "files=" >> "$GITHUB_OUTPUT"
          fi

      #----------- macOS Packaged Check -----------------------
      - name: Check packaged runtime deps (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          set -e
          TAG=${{ github.event.release.tag_name }}
          PKG=Perple_X_${TAG}_macOS_64_gfortran
          for f in "$PKG/bin/"*; do
            if file "$f" | grep -q Mach-O; then
              echo "== $f =="
              if otool -L "$f" | grep -Eiq "/opt/homebrew/"; then
                echo "Found unwanted Homebrew runtime deps in $f"
                otool -L "$f"
                exit 1
              fi
              # sanity: ensure quadmath is now via @rpath
              if ! otool -L "$f" | grep -q "@rpath/libquadmath.0.dylib"; then
                echo "Expected @rpath quadmath not found in $f"
                otool -L "$f"
                exit 1
              fi
            fi
          done

        # debug step removed

      - name: Publish artifacts to GitHub release (if any)
        if: steps.build_list.outputs.files != ''
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.event.release.tag_name }}
          files: ${{ steps.build_list.outputs.files }}

      - name: Log no artifacts found
        if: steps.build_list.outputs.files == ''
        run: |
          echo "No build artifacts were found to publish."
