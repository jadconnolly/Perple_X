name: CI

on: [push, pull_request]

jobs:
  build:
    name: Build - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup julia
        uses: julia-actions/setup-julia@v1
        with:
          version: '1.8'
          arch: 'x64'

      # ----------------- Compilers per OS -----------------

      - name: Install compilers (Linux)
        if: contains(matrix.os, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y gfortran make


          # Try to locate gfortran / mingw bin directory in several common locations
          $found = $false
          $gfortranCmd = Get-Command gfortran -ErrorAction SilentlyContinue
          if ($gfortranCmd) {
            Write-Host "Found gfortran at $($gfortranCmd.Path)"
            $found = $true
          } else {
            $candidates = @(
              'C:\tools\mingw64\bin',
              'C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin',
              'C:\Program Files\mingw-w64\mingw64\bin',
              'C:\msys64\mingw64\bin'
            )
            foreach ($p in $candidates) {
              if (Test-Path $p) {
                Write-Host "Adding $p to PATH"
                echo $p | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
                $found = $true
                break
              }
            }
          }

          if (-not $found) {
            Write-Warning "MinGW/gfortran not found in standard locations; continuing but gfortran may be unavailable."
          }
        run: |
          choco install mingw -y
          choco install cmake -y

          $mingwPath = "C:\tools\mingw64\bin"
          if (Test-Path $mingwPath) {
            echo "Using MinGW at $mingwPath"
            echo "$mingwPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          } else {
            Write-Error "MinGW path not found at $mingwPath"
          }

      - name: Check gfortran (Windows)
        if: contains(matrix.os, 'windows')
        shell: pwsh
        run: |
          $gfortran = Get-Command gfortran -ErrorAction SilentlyContinue
          if ($gfortran) {
            gfortran --version
          } else {
            Write-Warning "gfortran not found; Windows build may fail later if gfortran is required."
          }

      # ----------------- Compile sources -----------------

      - name: Compile sources (Windows)
        if: contains(matrix.os, 'windows')
        shell: pwsh
        run: |
          make -C src -f makefile EXT=.exe

      - name: Compile sources (Linux/macOS)
        if: ${{ !contains(matrix.os, 'windows') }}
        run: |
          make -C src -f makefile

      # ----------------- Compile shared libraries --------------hh---

      - name: Compile libraries (Windows)
        if: contains(matrix.os, 'windows')
        shell: pwsh
        run: |
          make -C src -f makefile FLINK='-shared' FFLAGS='-fPIC -O3' EXT=.dll

      - name: Compile libraries (Linux)
        if: contains(matrix.os, 'ubuntu')
        run: |
          make -C src -f makefile FLINK='-shared' FFLAGS='-fPIC -O3' EXT=.so

      - name: Compile libraries (macOS)
        if: contains(matrix.os, 'macos')
        run: |
          make -C src -f makefile FLINK='-shared' FFLAGS='-fPIC -O3' EXT=.dylib

      # ----------------- Julia tests -----------------

      - name: Setup julia testing framework
        uses: julia-actions/julia-buildpkg@latest

      - name: Run tests (through julia)
        uses: julia-actions/julia-runtest@latest
